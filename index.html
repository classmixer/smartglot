<!doctype html>
<html>
  <head>
    <title>Smartglot - Term Analysis</title>
    <!-- Firebase SDK scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-functions-compat.js"></script>
    <script>
      // Firebase 구성
      var firebaseConfig = {
        apiKey: 'AIzaSyA0iVwY44v9lokoS2Zm_jl9pYc8pV6Nje8', // Replace with your actual API key
        authDomain: 'smartglot.firebaseapp.com',
        projectId: 'smartglot',
        storageBucket: 'smartglot.firebasestorage.app', // Corrected bucket name
        messagingSenderId: '516870202505',
        appId: '1:516870202505:web:377f047b4883a84fd69366',
        measurementId: 'G-F0531X25FB',
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const storage = firebase.storage(); // Initialize Cloud Storage
      const functions = firebase.functions(); // Initialize Cloud Functions
    </script>

    <style>
      /* Basic styling */
      body {
        font-family: sans-serif;
        padding: 0; /* Remove body padding */
        margin: 0; /* Remove body margin */
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
      .container {
        padding: 20px;
        flex-grow: 1;
      }
      header {
        background-color: #f1f1f1;
        padding: 10px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #ccc;
      }
      header h1 {
        margin: 0;
        font-size: 1.5em;
      }
      header nav button {
        margin-left: 10px;
        padding: 8px 12px;
      }
      #welcome-container {
        text-align: center;
        padding: 40px 20px;
      }
      #welcome-container h2 {
        margin-bottom: 20px;
      }
      #welcome-container p {
        max-width: 600px;
        margin: 0 auto 20px auto;
        line-height: 1.6;
      }
      #welcome-container button {
        margin-top: 10px;
        padding: 12px 20px;
        font-size: 1.1em;
      }
      textarea {
        width: 80%;
        min-height: 150px;
        margin-bottom: 10px;
        display: block;
      }
      button {
        padding: 10px 15px;
        cursor: pointer;
      }
      input[type='email'],
      input[type='password'] {
        padding: 8px;
        margin-right: 5px;
        margin-bottom: 10px; /* Add space below inputs */
        display: block; /* Make inputs block level */
        width: calc(100% - 18px); /* Adjust width */
        max-width: 300px; /* Max width for inputs */
      }
      #results {
        margin-top: 20px;
        border: 1px solid #ccc;
        padding: 10px;
        min-height: 50px;
        background-color: #f9f9f9;
      }
      .result-item {
        border-bottom: 1px dotted #eee;
        padding: 5px 0;
      }
      .result-item .term {
        font-weight: bold;
      }
      .result-item .freq {
        margin-left: 10px;
        color: #555;
      }
      #auth-container,
      #analysis-container {
        margin: 30px auto; /* Center containers */
        padding: 20px;
        border: 1px solid #eee;
        border-radius: 5px;
        max-width: 500px; /* Limit width */
        display: none; /* Initially hidden */
      }
      #auth-container h2,
      #analysis-container h2 {
        text-align: center;
        margin-bottom: 20px;
      }
      #user-status {
        /* Renamed from user-info */
        text-align: right;
        font-size: 0.9em;
        color: #555;
      }
      .auth-section {
        margin-bottom: 15px;
        padding-top: 10px;
        border-top: 1px solid #eee;
      }
      .auth-section:first-of-type {
        border-top: none;
        padding-top: 0;
      }
      .auth-section h3 {
        margin-top: 0;
        margin-bottom: 15px;
      }
      #error-message {
        color: red;
        margin-top: 10px;
        margin-bottom: 15px; /* Add margin below error */
        font-size: 0.9em;
        min-height: 1.2em; /* Reserve space for error */
        text-align: center;
      }
      .input-error {
        border: 1px solid red;
      }

      /* Email verification notice style */
      #email-verification-notice {
        padding: 10px;
        background-color: #fff3cd;
        border: 1px solid #ffeeba;
        color: #856404;
        border-radius: 4px;
        margin-bottom: 15px;
        text-align: center;
        display: none; /* Initially hidden */
      }
      #email-verification-notice a {
        color: #0056b3;
        text-decoration: underline;
      }

      /* Initial display states */
      #auth-container,
      #analysis-container,
      #headerLogoutButton {
        display: none;
      }
      #welcome-container,
      #headerLoginButton,
      #headerSignupButton {
        display: block; /* Adjust display for header buttons later */
      }
      header nav {
        /* Container for header buttons */
        display: flex;
        align-items: center;
      }

      /* Profile Icon Style */
      .profile-icon {
        display: inline-block;
        width: 36px;
        height: 36px;
        border-radius: 50%; /* 원형 모양 */
        background-color: #007bff; /* 배경색 */
        color: white; /* 글자색 */
        text-align: center;
        line-height: 36px; /* 글자 세로 중앙 정렬 */
        font-size: 1em;
        font-weight: bold;
        cursor: pointer;
        border: none;
        margin-right: 15px; /* 로그아웃 버튼과의 간격 */
      }

      /* Password visibility toggle styles */
      .password-wrapper {
        position: relative;
        width: calc(100% - 18px); /* Match input width style */
        max-width: 300px; /* Match input max-width */
        margin-bottom: 10px; /* Match input margin-bottom */
        /* Remove auto margins to align left like other inputs */
        margin-left: 0; /* Explicitly set to 0 or remove for default */
        margin-right: 0; /* Explicitly set to 0 or remove for default */
      }
      .password-wrapper input[type='password'],
      .password-wrapper input[type='text'] {
        /* Apply to text type too when toggled */
        width: 100%; /* Input takes full width of wrapper */
        padding-right: 40px; /* Make space for the icon */
        box-sizing: border-box; /* Include padding in width calculation */
        /* Inherit other input styles if needed */
        padding: 8px;
        margin: 0; /* Remove default margins */
        display: block;
      }
      .toggle-password {
        position: absolute;
        right: 5px; /* Position inside the input area */
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        cursor: pointer;
        padding: 5px;
        /* font-size: 1.2em; */ /* 아이콘 크기 조정을 위해 제거 또는 수정 */
        line-height: 1; /* Prevent extra spacing */
        color: #555; /* Icon color */
        width: 24px; /* SVG 아이콘 크기에 맞게 너비 조정 */
        height: 24px; /* SVG 아이콘 크기에 맞게 높이 조정 */
      }
      .toggle-password img {
        width: 100%;
        height: 100%;
        display: block;
      }
      .toggle-password:focus {
        outline: none;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Smartglot</h1>
      <nav>
        <button
          id="profile-icon-button"
          class="profile-icon"
          style="display: none"
        ></button>
        <button id="headerLoginButton">Login</button>
        <button id="headerSignupButton">Sign Up</button>
        <button id="headerLogoutButton">Logout</button>
      </nav>
    </header>

    <div class="container">
      <!-- Welcome Section -->
      <div id="welcome-container">
        <h2>Welcome to Smartglot!</h2>
        <p>Just put in a document and get your own glossary.</p>
        <p>Log in or sign up to start analyzing your text.</p>
        <button id="getStartedButton">Get Started</button>
      </div>

      <!-- Authentication Section -->
      <div id="auth-container">
        <h2>Authentication</h2>
        <div id="error-message"></div>
        <div id="email-verification-notice" style="display: none"></div>

        <!-- Login Form -->
        <div id="login-section" class="auth-section">
          <h3>Login</h3>
          <input type="email" id="loginEmail" placeholder="Email" />
          <div class="password-wrapper">
            <input type="password" id="loginPassword" placeholder="Password" />
            <button
              type="button"
              class="toggle-password"
              aria-label="Show password"
            >
              <img src="eye-password-hide.svg" alt="Show password" />
            </button>
          </div>
          <button id="loginButton">Login</button>
          <button
            id="googleLoginButton"
            style="margin-top: 10px; background-color: #db4437; color: white"
          >
            <img
              src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg"
              alt="Google icon"
              style="height: 1em; vertical-align: middle; margin-right: 8px"
            />Sign in with Google
          </button>
          <p>
            Don't have an account? <a href="#" id="showSignupLink">Sign Up</a>
          </p>
        </div>

        <!-- Sign Up Form -->
        <div id="signup-section" class="auth-section" style="display: none">
          <h3>Sign Up</h3>
          <input type="email" id="signupEmail" placeholder="Email" />
          <div class="password-wrapper">
            <input type="password" id="signupPassword" placeholder="Password" />
            <button
              type="button"
              class="toggle-password"
              aria-label="Show password"
            >
              <img src="eye-password-hide.svg" alt="Show password" />
            </button>
          </div>
          <div class="password-wrapper">
            <input
              type="password"
              id="signupPasswordConfirm"
              placeholder="Confirm Password"
            />
            <button
              type="button"
              class="toggle-password"
              aria-label="Show password"
            >
              <img src="eye-password-hide.svg" alt="Show password" />
            </button>
          </div>
          <button id="signupButton">Sign Up</button>
          <p>
            Already have an account? <a href="#" id="showLoginLink">Login</a>
          </p>
        </div>
        <!-- Removed the separate logout button from here -->
      </div>

      <!-- Analysis Section -->
      <div id="analysis-container">
        <h2>Upload PDF to Analyze</h2>
        <hr style="margin: 20px 0" />

        <!-- PDF Input -->
        <div id="pdf-analysis-section">
          <label for="pdfInput">Or upload a PDF:</label>
          <input
            type="file"
            id="pdfInput"
            accept=".pdf"
            style="display: block; margin-top: 5px; margin-bottom: 10px"
          />
          <button id="analyzePdfButton" disabled>Analyze PDF</button>
          <span
            id="pdf-upload-status"
            style="margin-left: 10px; font-size: 0.9em"
          ></span>
        </div>

        <h2>Top Terms</h2>
        <div id="results">Enter text or upload a PDF and click analyze.</div>
      </div>
    </div>
    <!-- /container -->

    <!-- Profile Screen Section (New) -->
    <div
      id="profile-container"
      style="
        display: none;
        margin: 30px auto;
        padding: 20px;
        border: 1px solid #eee;
        border-radius: 5px;
        max-width: 500px;
        text-align: center;
      "
    >
      <h2>Profile</h2>
      <p id="profile-email"></p>

      <!-- Password Change Section -->
      <div
        style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee"
      >
        <h3>Change Password</h3>
        <div class="password-wrapper">
          <input
            type="password"
            id="currentPassword"
            placeholder="Current Password"
          />
          <button
            type="button"
            class="toggle-password"
            aria-label="Show password"
          >
            <img src="eye-password-hide.svg" alt="Show password" />
          </button>
        </div>
        <div class="password-wrapper">
          <input type="password" id="newPassword" placeholder="New Password" />
          <button
            type="button"
            class="toggle-password"
            aria-label="Show password"
          >
            <img src="eye-password-hide.svg" alt="Show password" />
          </button>
        </div>
        <div class="password-wrapper">
          <input
            type="password"
            id="newPasswordConfirm"
            placeholder="Confirm New Password"
          />
          <button
            type="button"
            class="toggle-password"
            aria-label="Show password"
          >
            <img src="eye-password-hide.svg" alt="Show password" />
          </button>
        </div>
        <button id="changePasswordButton">Change Password</button>
        <p
          id="password-change-message"
          style="margin-top: 10px; font-size: 0.9em; min-height: 1.2em"
        ></p>
      </div>

      <button id="backToAnalysisButton" style="margin-top: 20px">
        Back to Analysis
      </button>
      <button
        id="deleteAccountButton"
        style="background-color: #dc3545; color: white; margin-top: 20px"
      >
        Delete Account
      </button>
      <p
        id="profile-error-message"
        style="
          color: red;
          margin-top: 10px;
          font-size: 0.9em;
          min-height: 1.2em;
        "
      ></p>
    </div>

    <!-- Firebase Initialization Script (already done above) -->
    <script>
      // const firebaseConfig = { /* ... */ }; // Already defined
      // firebase.initializeApp(firebaseConfig); // Already initialized
      // const auth = firebase.auth(); // Already defined
    </script>

    <!-- Load index.js AFTER auth is defined and DOM is ready -->
    <!-- We will move the JS logic here for simplicity -->

    <script>
      // DOM Elements
      const welcomeContainer = document.getElementById('welcome-container');
      const authContainer = document.getElementById('auth-container');
      const analysisContainer = document.getElementById('analysis-container');
      const profileContainer = document.getElementById('profile-container'); // Profile container

      const headerLoginButton = document.getElementById('headerLoginButton');
      const headerSignupButton = document.getElementById('headerSignupButton');
      const headerLogoutButton = document.getElementById('headerLogoutButton');
      const profileIconButton = document.getElementById('profile-icon-button'); // Profile icon button

      const getStartedButton = document.getElementById('getStartedButton'); // New button
      const showSignupLink = document.getElementById('showSignupLink');
      const showLoginLink = document.getElementById('showLoginLink');

      const loginSection = document.getElementById('login-section');
      const signupSection = document.getElementById('signup-section');
      const loginEmailInput = document.getElementById('loginEmail');
      const loginPasswordInput = document.getElementById('loginPassword');
      const loginButton = document.getElementById('loginButton'); // Inside auth container

      const signupEmailInput = document.getElementById('signupEmail');
      const signupPasswordInput = document.getElementById('signupPassword');
      const signupPasswordConfirmInput = document.getElementById(
        'signupPasswordConfirm',
      );
      const signupButton = document.getElementById('signupButton'); // Inside auth container
      const googleLoginButton = document.getElementById('googleLoginButton'); // Google Login Button

      const errorMessageDiv = document.getElementById('error-message');
      const emailVerificationNoticeDiv = document.getElementById(
        'email-verification-notice',
      ); // Email verification notice

      const resultsDiv = document.getElementById('results');

      // New/Updated Elements for Text/PDF analysis differentiation
      const pdfInput = document.getElementById('pdfInput');
      const analyzePdfButton = document.getElementById('analyzePdfButton');
      const pdfUploadStatusSpan = document.getElementById('pdf-upload-status');

      // Profile screen elements
      const currentPasswordInput = document.getElementById('currentPassword');
      const newPasswordInput = document.getElementById('newPassword');
      const newPasswordConfirmInput =
        document.getElementById('newPasswordConfirm');
      const changePasswordButton = document.getElementById(
        'changePasswordButton',
      );
      const passwordChangeMessageP = document.getElementById(
        'password-change-message',
      );
      const profileEmailP = document.getElementById('profile-email');
      const backToAnalysisButton = document.getElementById(
        'backToAnalysisButton',
      );
      const deleteAccountButton = document.getElementById(
        'deleteAccountButton',
      );
      const profileErrorMessageDiv = document.getElementById(
        'profile-error-message',
      );

      // --- Global variables for email verification polling ---
      let emailVerificationInterval = null;
      const POLLING_TIMEOUT_MS = 5 * 60 * 1000; // 5 minutes
      let pollingStartTime = null;

      // --- UI Control Functions ---
      function showWelcomeScreen() {
        welcomeContainer.style.display = 'block';
        authContainer.style.display = 'none';
        analysisContainer.style.display = 'none';
        profileContainer.style.display = 'none'; // Hide profile
        headerLoginButton.style.display = 'inline-block'; // Use inline-block for buttons
        headerSignupButton.style.display = 'inline-block';
        headerLogoutButton.style.display = 'none';
        profileIconButton.style.display = 'none'; // Hide profile icon
        profileIconButton.textContent = ''; // Clear profile icon text
        clearAuthError();
        clearAuthForms();
        if (emailVerificationNoticeDiv)
          emailVerificationNoticeDiv.style.display = 'none'; // Hide verification notice
      }

      function showAuthScreen(showLogin = true) {
        welcomeContainer.style.display = 'none';
        authContainer.style.display = 'block';
        analysisContainer.style.display = 'none';
        profileContainer.style.display = 'none'; // Hide profile
        headerLoginButton.style.display = 'none'; // Hide header buttons when auth form is shown
        headerSignupButton.style.display = 'none';
        headerLogoutButton.style.display = 'none';
        profileIconButton.style.display = 'none'; // Hide profile icon
        profileIconButton.textContent = ''; // Clear profile icon text
        if (showLogin) {
          loginSection.style.display = 'block';
          signupSection.style.display = 'none';
        } else {
          loginSection.style.display = 'none';
          signupSection.style.display = 'block';
        }
        clearAuthError();
        // emailVerificationNoticeDiv.style.display = 'none'; // Verification notice visibility managed by signup/authStateChange
      }

      function showAnalysisScreen(user) {
        welcomeContainer.style.display = 'none';
        authContainer.style.display = 'none';
        analysisContainer.style.display = 'block';
        profileContainer.style.display = 'none'; // Hide profile
        headerLoginButton.style.display = 'none';
        headerSignupButton.style.display = 'none';
        headerLogoutButton.style.display = 'inline-block';
        if (emailVerificationNoticeDiv)
          emailVerificationNoticeDiv.style.display = 'none'; // Hide verification notice

        // Set profile icon
        const emailPrefix = user.email.substring(0, 2).toUpperCase();
        profileIconButton.textContent = emailPrefix;
        profileIconButton.style.display = 'inline-block';

        clearAuthError();
        clearAuthForms(); // Clear forms after successful login/signup
        // Optionally clear analysis results/input on showing the screen
        resultsDiv.innerHTML = 'Enter text or upload a PDF and click analyze.';
        pdfInput.value = null; // Clear the selected file
        analyzePdfButton.disabled = true; // Disable PDF button initially
        pdfUploadStatusSpan.textContent = ''; // Clear status
      }

      // --- Event Listeners for UI Navigation ---
      headerLoginButton.addEventListener('click', () => showAuthScreen(true));
      headerSignupButton.addEventListener('click', () => showAuthScreen(false));
      getStartedButton.addEventListener('click', () => showAuthScreen(true)); // Get Started shows login
      showSignupLink.addEventListener('click', (e) => {
        e.preventDefault();
        showAuthScreen(false);
      });
      showLoginLink.addEventListener('click', (e) => {
        e.preventDefault();
        showAuthScreen(true);
      });

      // --- Password Visibility Toggle Logic ---
      const togglePasswordButtons =
        document.querySelectorAll('.toggle-password');

      togglePasswordButtons.forEach((button) => {
        button.addEventListener('click', () => {
          const passwordInput = button.previousElementSibling;
          const type =
            passwordInput.getAttribute('type') === 'password'
              ? 'text'
              : 'password';
          passwordInput.setAttribute('type', type);

          // Change the icon based on the type
          const img = button.querySelector('img');
          if (img) {
            img.src =
              type === 'password'
                ? 'eye-password-hide.svg'
                : 'eye-password-show.svg';
            img.alt = type === 'password' ? 'Show password' : 'Hide password';
          }
          // Optionally change aria-label for accessibility
          button.setAttribute(
            'aria-label',
            type === 'password' ? 'Show password' : 'Hide password',
          );
        });
      });

      // --- Authentication Logic ---

      // Function to display error messages
      function showAuthError(message) {
        errorMessageDiv.textContent = message;
        // Clear previous errors visually
        loginEmailInput.classList.remove('input-error');
        loginPasswordInput.classList.remove('input-error');
        signupEmailInput.classList.remove('input-error');
        signupPasswordInput.classList.remove('input-error');
        signupPasswordConfirmInput.classList.remove('input-error');
      }

      // Function to clear error messages and input styles
      function clearAuthError() {
        errorMessageDiv.textContent = '';
        loginEmailInput.classList.remove('input-error');
        loginPasswordInput.classList.remove('input-error');
        signupEmailInput.classList.remove('input-error');
        signupPasswordInput.classList.remove('input-error');
        signupPasswordConfirmInput.classList.remove('input-error');
      }

      // Function to clear login/signup form inputs
      function clearAuthForms() {
        loginEmailInput.value = '';
        loginPasswordInput.value = '';
        signupEmailInput.value = '';
        signupPasswordInput.value = '';
        signupPasswordConfirmInput.value = '';
      }

      // Sign Up Button (inside auth container)
      signupButton.addEventListener('click', async () => {
        clearAuthError();
        const email = signupEmailInput.value;
        const password = signupPasswordInput.value;
        const passwordConfirm = signupPasswordConfirmInput.value;

        if (password !== passwordConfirm) {
          showAuthError('Passwords do not match.');
          signupPasswordInput.classList.add('input-error');
          signupPasswordConfirmInput.classList.add('input-error');
          return;
        }

        if (!email || !password) {
          showAuthError('Email and password cannot be empty.');
          if (!email) signupEmailInput.classList.add('input-error');
          if (!password) {
            signupPasswordInput.classList.add('input-error');
            signupPasswordConfirmInput.classList.add('input-error');
          }
          return;
        }

        try {
          await auth.createUserWithEmailAndPassword(email, password);
          console.log('User signed up successfully!');
          // UI will update via onAuthStateChanged, which calls showAnalysisScreen
          // Send email verification
          const user = auth.currentUser;
          if (user) {
            await user.sendEmailVerification();
            console.log('Verification email sent.');
            // Clear forms and show message to check email
            clearAuthForms();
            emailVerificationNoticeDiv.innerHTML =
              '회원가입이 거의 완료되었습니다! <strong>이메일을 확인하여 계정을 인증해주세요.</strong> 인증 후 로그인할 수 있습니다. <a href="#" id="resendVerificationEmailLink">인증 이메일 재전송</a>';
            emailVerificationNoticeDiv.style.display = 'block';
            showAuthScreen(true); // Show login form after signup attempt

            const resendLink = document.getElementById(
              'resendVerificationEmailLink',
            );
            if (resendLink) {
              resendLink.addEventListener('click', async (e) => {
                e.preventDefault();
                try {
                  await user.sendEmailVerification();
                  emailVerificationNoticeDiv.innerHTML =
                    '인증 이메일이 다시 전송되었습니다. 이메일함을 확인해주세요. <a href="#" id="resendVerificationEmailLink">인증 이메일 재전송</a>';
                  // Re-attach event listener to new link if needed or handle differently
                } catch (error) {
                  console.error('Error resending verification email:', error);
                  showAuthError(
                    '인증 이메일 재전송에 실패했습니다: ' + error.message,
                  );
                }
              });
            }
          }
        } catch (error) {
          console.error('Sign up failed:', error);
          if (error.code === 'auth/email-already-in-use') {
            // Check if the email is linked to Google Sign-In
            try {
              const signInMethods =
                await auth.fetchSignInMethodsForEmail(email);
              if (
                signInMethods.includes(
                  firebase.auth.GoogleAuthProvider.PROVIDER_ID,
                )
              ) {
                showAuthError(
                  '이미 Google 계정으로 가입된 이메일입니다. Google 로그인을 이용해주세요.',
                );
                signupEmailInput.classList.add('input-error');
              } else {
                showAuthError(
                  '이메일이 이미 사용 중입니다. 다른 이메일을 사용하거나 로그인해주세요.',
                );
                signupEmailInput.classList.add('input-error');
              }
            } catch (fetchError) {
              // Fallback error message if fetchSignInMethodsForEmail fails
              showAuthError(
                '가입에 실패했습니다: 이메일이 이미 사용 중일 수 있습니다.',
              );
              signupEmailInput.classList.add('input-error');
            }
          } else if (error.code === 'auth/invalid-email') {
            signupEmailInput.classList.add('input-error');
            showAuthError('유효하지 않은 이메일 주소입니다.');
          } else if (error.code === 'auth/weak-password') {
            signupPasswordInput.classList.add('input-error');
            signupPasswordConfirmInput.classList.add('input-error');
            showAuthError('비밀번호는 6자 이상이어야 합니다.');
          } else {
            showAuthError(`가입 실패: ${error.message}`);
          }
        }
      });

      // Login Button (inside auth container)
      loginButton.addEventListener('click', async () => {
        clearAuthError();
        const email = loginEmailInput.value;
        const password = loginPasswordInput.value;

        if (!email || !password) {
          showAuthError('Email and password cannot be empty.');
          if (!email) loginEmailInput.classList.add('input-error');
          if (!password) loginPasswordInput.classList.add('input-error');
          return;
        }

        try {
          await auth.signInWithEmailAndPassword(email, password);
          console.log('User logged in successfully!');
          // UI will update via onAuthStateChanged, which calls showAnalysisScreen
          // It will check for emailVerified status there
        } catch (error) {
          console.error('Login failed:', error);
          if (
            error.code === 'auth/invalid-email' ||
            error.code === 'auth/user-not-found' ||
            error.code === 'auth/invalid-credential'
          ) {
            loginEmailInput.classList.add('input-error');
          }
          if (
            error.code === 'auth/wrong-password' ||
            error.code === 'auth/invalid-credential'
          ) {
            loginPasswordInput.classList.add('input-error');
          }
          showAuthError(`Login failed: ${error.message}`);
        }
      });

      // Google Login Button
      googleLoginButton.addEventListener('click', async () => {
        clearAuthError();
        const provider = new firebase.auth.GoogleAuthProvider();
        try {
          await auth.signInWithPopup(provider);
          console.log('User logged in with Google successfully!');
          // UI will update via onAuthStateChanged
        } catch (error) {
          console.error('Google login failed:', error);
          let message = `Google 로그인 실패: ${error.message}`;
          if (error.code === 'auth/popup-closed-by-user') {
            message =
              'Google 로그인 팝업이 사용자에 의해 닫혔습니다. 다시 시도해주세요.';
          } else if (
            error.code === 'auth/account-exists-with-different-credential'
          ) {
            message =
              '이미 다른 로그인 방식으로 가입된 이메일입니다. 기존 방식으로 로그인해주세요.';
          }
          showAuthError(message);
        }
      });

      // Logout (Header Button)
      headerLogoutButton.addEventListener('click', async () => {
        clearAuthError(); // Clear any lingering errors
        try {
          await auth.signOut();
          console.log('User logged out successfully!');
          // UI will update via onAuthStateChanged, which calls showWelcomeScreen
        } catch (error) {
          console.error('Logout failed:', error);
          // Show error somewhere? Maybe an alert for logout errors?
          alert(`Logout failed: ${error.message}`);
        }
      });

      // Add Enter key listeners to input fields
      loginEmailInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault(); // Prevent default form submission
          loginButton.click();
        }
      });
      loginPasswordInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          loginButton.click();
        }
      });

      signupEmailInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          signupButton.click();
        }
      });
      signupPasswordInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          signupButton.click();
        }
      });
      signupPasswordConfirmInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          signupButton.click();
        }
      });

      // Listen for Auth State Changes
      auth.onAuthStateChanged((user) => {
        // Clear any existing polling interval when auth state changes significantly
        if (emailVerificationInterval) {
          clearInterval(emailVerificationInterval);
          emailVerificationInterval = null;
          pollingStartTime = null;
          console.log(
            'Cleared existing email verification interval due to auth state change.',
          );
        }

        if (user) {
          // User is signed in
          if (
            !user.emailVerified &&
            user.providerData.some(
              (provider) => provider.providerId === 'password',
            )
          ) {
            // If signed in with email/password but email is not verified
            console.log(
              'User signed in but email not verified. Setting up verification check...',
            );
            welcomeContainer.style.display = 'none';
            analysisContainer.style.display = 'none';
            profileContainer.style.display = 'none';
            authContainer.style.display = 'block'; // Show auth container for message
            loginSection.style.display = 'block'; // Show login section part of auth
            signupSection.style.display = 'none';

            emailVerificationNoticeDiv.innerHTML = `<strong>계정 인증이 필요합니다.</strong> ${user.email} 주소로 발송된 인증 메일을 확인해주세요. 인증이 확인되면 자동으로 로그인됩니다. <a href="#" id="resendVerificationEmailInAuthLink">인증 이메일 재전송</a>`;
            emailVerificationNoticeDiv.style.display = 'block';

            const resendLinkInAuth = document.getElementById(
              'resendVerificationEmailInAuthLink',
            );
            if (resendLinkInAuth) {
              resendLinkInAuth.addEventListener('click', async (e) => {
                e.preventDefault();
                if (auth.currentUser) {
                  // Ensure user is still current
                  try {
                    await auth.currentUser.sendEmailVerification();
                    // Update message slightly, polling will continue or restart if needed by onAuthStateChanged logic
                    emailVerificationNoticeDiv.innerHTML =
                      '인증 이메일이 다시 전송되었습니다. 이메일함을 확인해주세요. 잠시 후 자동으로 로그인됩니다. <a href="#" id="resendVerificationEmailInAuthLink">인증 이메일 재전송</a>';
                  } catch (error_resend) {
                    console.error(
                      'Error resending verification email:',
                      error_resend,
                    );
                    showAuthError(
                      '인증 이메일 재전송에 실패했습니다: ' +
                        error_resend.message,
                    );
                  }
                } else {
                  showAuthError(
                    '사용자 정보를 찾을 수 없어 이메일을 재전송할 수 없습니다. 다시 로그인해주세요.',
                  );
                }
              });
            }

            // Start polling if not already active for this unverified session
            if (!emailVerificationInterval) {
              console.log('Starting email verification polling.');
              pollingStartTime = Date.now();
              emailVerificationInterval = setInterval(async () => {
                if (Date.now() - pollingStartTime > POLLING_TIMEOUT_MS) {
                  console.log('Email verification polling timed out.');
                  clearInterval(emailVerificationInterval);
                  emailVerificationInterval = null;
                  pollingStartTime = null;
                  emailVerificationNoticeDiv.innerHTML = `이메일 인증 시간이 초과되었습니다. <strong><a href="#" onclick="window.location.reload()">페이지를 새로고침</a></strong>하거나 다시 로그인해주세요. <a href="#" id="resendVerificationEmailTimeoutLink">인증 이메일 재전송</a>`;
                  const resendLinkTimeout = document.getElementById(
                    'resendVerificationEmailTimeoutLink',
                  );
                  if (resendLinkTimeout) {
                    resendLinkTimeout.addEventListener(
                      'click',
                      async (e_timeout) => {
                        e_timeout.preventDefault();
                        if (auth.currentUser) {
                          try {
                            await auth.currentUser.sendEmailVerification();
                            emailVerificationNoticeDiv.innerHTML =
                              '인증 이메일이 다시 전송되었습니다. 이메일함을 확인해주세요. 인증이 확인되면 자동으로 로그인됩니다. <a href="#" id="resendVerificationEmailTimeoutLink">인증 이메일 재전송</a>';
                            // Optionally, restart polling here if desired, or prompt refresh/re-login
                            // For simplicity, we are not restarting polling automatically on timeout resend.
                          } catch (error_resend_timeout) {
                            showAuthError(
                              '인증 이메일 재전송에 실패했습니다: ' +
                                error_resend_timeout.message,
                            );
                          }
                        } else {
                          showAuthError(
                            '사용자 정보를 찾을 수 없어 이메일을 재전송할 수 없습니다. 다시 로그인해주세요.',
                          );
                        }
                      },
                    );
                  }
                  return; // Stop this interval execution
                }

                const currentUserForPolling = auth.currentUser; // Use the most current user from auth service
                if (
                  currentUserForPolling &&
                  currentUserForPolling.uid === user.uid
                ) {
                  // Ensure we are polling for the same user
                  try {
                    await currentUserForPolling.reload(); // Reload user data from server
                    if (currentUserForPolling.emailVerified) {
                      console.log('Email verified! Proceeding to login.');
                      clearInterval(emailVerificationInterval);
                      emailVerificationInterval = null;
                      pollingStartTime = null;
                      showAnalysisScreen(currentUserForPolling); // Use the reloaded user object
                    } else {
                      console.log(
                        'Email not yet verified. Continuing polling...',
                      );
                    }
                  } catch (reloadError) {
                    console.error(
                      'Error reloading user during polling:',
                      reloadError,
                    );
                    // Consider stopping polling if reloadError indicates a persistent issue (e.g. user disabled/deleted)
                    // For now, we let it continue until timeout or successful verification.
                  }
                } else if (!currentUserForPolling) {
                  console.log(
                    'User became null during polling. Stopping interval.',
                  );
                  clearInterval(emailVerificationInterval);
                  emailVerificationInterval = null;
                  pollingStartTime = null;
                  // onAuthStateChanged will handle the signed-out state.
                } else {
                  // User changed during polling, current interval is for a different user.
                  // This case should ideally be handled by the top-level interval clear in onAuthStateChanged.
                  console.log(
                    'Polling for a user that is no longer the active user. Interval will be cleared.',
                  );
                }
              }, 5000); // Poll every 5 seconds
            }

            // Show limited header: only logout and profile icon (if logic allows for unverified users)
            headerLoginButton.style.display = 'none';
            headerSignupButton.style.display = 'none';
            headerLogoutButton.style.display = 'inline-block'; // Allow logout

            const emailPrefix = user.email.substring(0, 2).toUpperCase();
            profileIconButton.textContent = emailPrefix;
            profileIconButton.style.display = 'inline-block'; // Show profile icon, clicking it might show profile screen or more options
          } else {
            // User is signed in AND (email is verified OR not an email/password user e.g. Google login)
            // Interval should have been cleared at the start of onAuthStateChanged or if it was for a previous state
            if (emailVerificationInterval) {
              console.warn(
                'Interval was unexpectedly active for a verified/social login user. Clearing.',
              );
              clearInterval(emailVerificationInterval);
              emailVerificationInterval = null;
              pollingStartTime = null;
            }

            if (profileContainer.style.display !== 'block') {
              showAnalysisScreen(user);
            }
            // Ensure email verification notice is hidden if user is verified or used social login
            if (emailVerificationNoticeDiv)
              emailVerificationNoticeDiv.style.display = 'none';
          }
        } else {
          // User is signed out
          // Interval should have been cleared at the start of onAuthStateChanged
          if (emailVerificationInterval) {
            console.warn(
              'Interval was unexpectedly active for a signed-out user. Clearing.',
            );
            clearInterval(emailVerificationInterval);
            emailVerificationInterval = null;
            pollingStartTime = null;
          }
          showWelcomeScreen();
        }
      });

      // --- Analysis Logic (existing, slightly modified) ---

      // Basic HTML escaping function (kept for reference, but prefer textContent)
      function escapeHtml(unsafe) {
        if (typeof unsafe !== 'string') return ''; // Ensure input is a string
        return unsafe
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      // Initialize the view based on initial auth state when the script runs
      // (onAuthStateChanged will handle subsequent changes)
      const initialUser = auth.currentUser;
      if (initialUser) {
        showAnalysisScreen(initialUser);
      } else {
        showWelcomeScreen();
      }

      // Function to show the Profile Screen
      function showProfileScreen(user) {
        welcomeContainer.style.display = 'none';
        authContainer.style.display = 'none';
        analysisContainer.style.display = 'none';
        profileContainer.style.display = 'block';
        if (emailVerificationNoticeDiv)
          emailVerificationNoticeDiv.style.display = 'none'; // Hide verification notice

        // Keep header buttons consistent with analysis screen
        headerLoginButton.style.display = 'none';
        headerSignupButton.style.display = 'none';
        headerLogoutButton.style.display = 'inline-block';
        profileIconButton.style.display = 'inline-block'; // Keep icon visible

        profileEmailP.textContent = `Email: ${user.email}`;
        profileErrorMessageDiv.textContent = ''; // Clear previous errors
        passwordChangeMessageP.textContent = ''; // Clear password change message
        // Clear password fields when showing the profile screen
        currentPasswordInput.value = '';
        newPasswordInput.value = '';
        newPasswordConfirmInput.value = '';
      }

      // Event Listener for Profile Icon Button
      profileIconButton.addEventListener('click', () => {
        const user = auth.currentUser;
        if (user) {
          showProfileScreen(user);
        }
      });

      // Event Listener for Back to Analysis Button
      backToAnalysisButton.addEventListener('click', () => {
        const user = auth.currentUser;
        if (user) {
          showAnalysisScreen(user); // Go back to analysis
        }
      });

      // Event Listener for Change Password Button
      changePasswordButton.addEventListener('click', async () => {
        const user = auth.currentUser;
        if (!user) return;
        if (
          !user.emailVerified &&
          user.providerData.some(
            (provider) => provider.providerId === 'password',
          )
        ) {
          profileErrorMessageDiv.textContent =
            '비밀번호를 변경하려면 먼저 이메일 인증을 완료해주세요.';
          profileErrorMessageDiv.style.color = 'red';
          return;
        }

        const currentPassword = currentPasswordInput.value;
        const newPassword = newPasswordInput.value;
        const newPasswordConfirm = newPasswordConfirmInput.value;

        passwordChangeMessageP.textContent = ''; // Clear previous message
        profileErrorMessageDiv.textContent = ''; // Clear general profile error

        // Basic validation
        if (!currentPassword || !newPassword || !newPasswordConfirm) {
          passwordChangeMessageP.textContent =
            '모든 비밀번호 필드를 입력해주세요.';
          passwordChangeMessageP.style.color = 'red';
          return;
        }
        if (newPassword !== newPasswordConfirm) {
          passwordChangeMessageP.textContent =
            '새 비밀번호가 일치하지 않습니다.';
          passwordChangeMessageP.style.color = 'red';
          newPasswordInput.classList.add('input-error');
          newPasswordConfirmInput.classList.add('input-error');
          return;
        }
        if (newPassword.length < 6) {
          // Firebase default minimum length
          passwordChangeMessageP.textContent =
            '새 비밀번호는 6자 이상이어야 합니다.';
          passwordChangeMessageP.style.color = 'red';
          newPasswordInput.classList.add('input-error');
          newPasswordConfirmInput.classList.add('input-error');
          return;
        }

        // Clear input error styles
        currentPasswordInput.classList.remove('input-error');
        newPasswordInput.classList.remove('input-error');
        newPasswordConfirmInput.classList.remove('input-error');

        try {
          // Re-authenticate the user
          const credential = firebase.auth.EmailAuthProvider.credential(
            user.email,
            currentPassword,
          );
          await user.reauthenticateWithCredential(credential);

          // If re-authentication is successful, update the password
          await user.updatePassword(newPassword);

          passwordChangeMessageP.textContent =
            '비밀번호가 성공적으로 변경되었습니다.';
          passwordChangeMessageP.style.color = 'green';
          console.log('Password updated successfully!');

          // Clear password fields after successful change
          currentPasswordInput.value = '';
          newPasswordInput.value = '';
          newPasswordConfirmInput.value = '';
        } catch (error) {
          console.error('Password change failed:', error);
          let message = '비밀번호 변경에 실패했습니다. 다시 시도해주세요.';
          if (error.code === 'auth/wrong-password') {
            message = '현재 비밀번호가 올바르지 않습니다.';
            currentPasswordInput.classList.add('input-error');
          } else if (error.code === 'auth/weak-password') {
            message = '새 비밀번호가 너무 약합니다. (최소 6자 이상)';
            newPasswordInput.classList.add('input-error');
            newPasswordConfirmInput.classList.add('input-error');
          }
          passwordChangeMessageP.textContent = message;
          passwordChangeMessageP.style.color = 'red';
        }
      });

      // Event Listener for Delete Account Button
      deleteAccountButton.addEventListener('click', async () => {
        const user = auth.currentUser;
        if (!user) return; // Should not happen if button is visible
        if (
          !user.emailVerified &&
          user.providerData.some(
            (provider) => provider.providerId === 'password',
          )
        ) {
          profileErrorMessageDiv.textContent =
            '계정을 삭제하려면 먼저 이메일 인증을 완료해주세요.';
          profileErrorMessageDiv.style.color = 'red';
          return;
        }

        profileErrorMessageDiv.textContent = ''; // Clear previous errors

        const confirmation = confirm(
          '정말 계정을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.',
        );

        if (confirmation) {
          try {
            await user.delete();
            console.log('User account deleted successfully.');
            // Auth state change will trigger showWelcomeScreen
          } catch (error) {
            console.error('Failed to delete account:', error);
            let message = 'Failed to delete account. Please try again.';
            if (error.code === 'auth/requires-recent-login') {
              message =
                'This operation requires recent login. Please log out and log back in before deleting your account.';
            }
            profileErrorMessageDiv.textContent = message;
          }
        }
      });

      // Event Listener for PDF File Input Change
      pdfInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file && file.type === 'application/pdf') {
          analyzePdfButton.disabled = false; // Enable button if PDF is selected
          pdfUploadStatusSpan.textContent = `Selected: ${file.name}`;
          resultsDiv.innerHTML = 'Click "Analyze PDF" to start.'; // Guide user
        } else {
          analyzePdfButton.disabled = true;
          pdfUploadStatusSpan.textContent = file
            ? 'Please select a PDF file.'
            : '';
          if (file) pdfInput.value = ''; // Clear invalid file selection
        }
      });

      // Event Listener for PDF Analysis Button
      analyzePdfButton.addEventListener('click', async () => {
        const user = auth.currentUser;
        const file = pdfInput.files[0];
        let filePath = null; // Declare filePath outside the try block

        if (!user) {
          resultsDiv.innerHTML = 'Please log in first.';
          showAuthScreen(true);
          return;
        }
        if (!file) {
          resultsDiv.innerHTML = 'Please select a PDF file first.';
          return;
        }

        resultsDiv.innerHTML = 'Uploading PDF...';
        analyzePdfButton.disabled = true; // Disable button during processing
        pdfUploadStatusSpan.textContent = 'Uploading...';

        try {
          const token = await user.getIdToken(); // Get token for backend function

          // 1. Upload PDF to Cloud Storage (using Firebase SDK)
          // Create a unique file path, e.g., using user ID and timestamp
          filePath = `uploads/${user.uid}/${Date.now()}_${file.name}`; // Assign value here
          const storageRef = firebase.storage().ref(filePath); // Use compat storage
          const uploadTask = await storageRef.put(file);
          const downloadURL = await uploadTask.ref.getDownloadURL(); // Optional: Get URL if needed

          pdfUploadStatusSpan.textContent = 'Processing PDF...';
          resultsDiv.innerHTML = 'Processing PDF with Vision AI...';

          // 2. Call the Cloud Function to analyze the PDF
          // Use Firebase Functions callable method
          const analyzePdfFunction = functions.httpsCallable('analyzePdf');

          const result = await analyzePdfFunction({ storagePath: filePath });
          const terms = result.data; // Callable functions return data in result.data

          displayAnalysisResults(terms); // Use the same display function

          pdfUploadStatusSpan.textContent = 'Analysis complete.';
        } catch (error) {
          console.error('PDF analysis process failed:', error);
          resultsDiv.innerHTML = `Error during PDF analysis: ${error.message}`;
          pdfUploadStatusSpan.textContent = 'Error.';
          // Attempt cleanup for callable errors too
          if (filePath) {
            // Check if filePath was assigned before trying to use it
            const storageRef = storage.ref(filePath); // Need filePath here
            try {
              await storageRef.delete();
              console.log('Cleaned up failed upload.');
            } catch (deleteError) {
              console.error('Failed to cleanup storage:', deleteError);
            }
          }
        } finally {
          // Re-enable button only if there's a file selected
          analyzePdfButton.disabled = !pdfInput.files[0];
        }
      });

      // --- Analysis Result Display Function (Refactored) ---
      function displayAnalysisResults(terms) {
        if (!Array.isArray(terms)) {
          console.error('Invalid terms format received:', terms);
          resultsDiv.innerHTML = 'Error: Invalid response format from server.';
          return;
        }

        if (terms.length === 0) {
          resultsDiv.innerHTML = 'No significant terms found.';
        } else {
          resultsDiv.innerHTML = ''; // Clear previous results
          terms.forEach((termData) => {
            if (
              termData &&
              typeof termData.term !== 'undefined' &&
              typeof termData.frequency !== 'undefined'
            ) {
              const itemDiv = document.createElement('div');
              itemDiv.classList.add('result-item');

              const termSpan = document.createElement('span');
              termSpan.className = 'term';
              termSpan.textContent = termData.term;

              const freqSpan = document.createElement('span');
              freqSpan.className = 'freq';
              freqSpan.textContent = ` (Frequency: ${termData.frequency})`;

              itemDiv.appendChild(termSpan);
              itemDiv.appendChild(freqSpan);
              resultsDiv.appendChild(itemDiv);
            } else {
              console.warn('Received invalid term data:', termData);
            }
          });
        }
      }
    </script>
  </body>
</html>
